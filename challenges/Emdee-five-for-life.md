# Emdee five for life

Navigating to the site, we see the following

![efff1](https://raw.githubusercontent.com/Shezz7/HTB-writeups/master/challenges/resources/efff1.png)

Try to md5 hash the string displayed and submit it.

![efff2](https://raw.githubusercontent.com/Shezz7/HTB-writeups/master/challenges/resources/efff2.png)

It says that we were too slow to submit the hash. The application probably has some sort of time limit to submit the hash of the string it generates. We can attempt to write a simple script to take in the displayed string, md5 hash it and post it back to the application.

## Examining the request

Examining the initial request using the browser, we see the following:

![efff3](https://raw.githubusercontent.com/Shezz7/HTB-writeups/master/challenges/resources/efff3.png)

A cookie is set in ```PHPSESSID``` which is the default identifier that PHP uses for cookies. While building our script we have to take this into account.

## Getting the displayed string

To get the displayed string we first do a simple curl:

```console
kali@kali:~$ curl http://206.189.121.131:30299/
<html>
<head>
<title>emdee five for life</title>
</head>
<body style="background-color:powderblue;">
<h1 align='center'>MD5 encrypt this string</h1><h3 align='center'>mHDGmix66zipSFZUAUM0</h3><center><form action="" method="post">
<input type="text" name="hash" placeholder="MD5" align='center'></input>
</br>
<input type="submit" value="Submit"></input>
</form></center>
</body>
</html>
```
We can then filter the string out using ```grep``` and ```curl```:

```console
kali@kali:~$ curl -s http://206.189.121.131:30299/ | grep h3 | cut -d '>' -f 4 | cut -f 1 -d '<'
ObO2YLXyrOu0sw57HgC4
```

## Calculating the MD5 hash

Now that we have the string, we can pipe this in to ```md5sum``` to get the md5 hash.

```console
kali@kali:~$ curl -s http://206.189.121.131:30299/ | grep h3 | cut -d '>' -f 4 | cut -f 1 -d '<' | md5sum
021b1ae9acdfd446bdc204c3bc8f1df9  -
```

The trailing hypen needs to go because we will post the hash in the field. To do so we do the following:

```console
kali@kali:~$ curl -s http://206.189.121.131:30299/ | grep h3 | cut -d '>' -f 4 | cut -f 1 -d '<' | md5sum | cut -d ' ' -f 1
125428a5f9dc739151c926579c243e8d
```

## Passing the MD5 hash

To pass in the MD5 hash, we examine in the browser console what the POST looks like:

![efff4](https://raw.githubusercontent.com/Shezz7/HTB-writeups/master/challenges/resources/efff4.png)

The form data is submitted in through a variable called ```hash```. Therefore to pass in the hash we can use a curl with the ```--data``` option as follows:

```curl --data "hash=<computed_hash>" -X POST http://206.189.121.131:30299/```

*NOTE: The string following ```--data``` must be in double quotes*

## Utilizing the cookie and putting it all together

To post the final hash, we also need to include the ```PHPSESSID``` parameter that we get from the first request. To do use we can use the ```--cookie-jar``` flag of curl in order to write the cookie to a file after the curl:

```console
kali@kali:~/$ curl --cookie-jar cookie.txt -s http://206.189.121.131:30299/ > /dev/null
kali@kali:~$ cat cookie.txt 
# Netscape HTTP Cookie File
# https://curl.haxx.se/docs/http-cookies.html
# This file was generated by libcurl! Edit at your own risk.

206.189.121.131 FALSE   /       FALSE   0       PHPSESSID       megjafgcohov5789hue3ibkvn4
```

Now that we have the cookie, we need to send the post using this cookie. To do so we can use the ```-b``` option of curl. Putting this all together we can build a simple script as follows:

```bash
#!/bin/bash

HOST=206.189.121.131
PORT=30299

str=$(curl -c cookie.txt -s http://$HOST:$PORT/ | grep h3 | cut -d '>' -f 4 | cut -f 1 -d '<')
echo "Got value $str"
hash=$(echo -n "$str" | md5sum | cut -d ' ' -f 1)
echo "Hash is $hash"
curl -b cookie.txt -d "hash=$hash" -X POST http://$HOST:$PORT/
```
Running it we finally get the flag:

```bash
Got value Ih4bMY9MmFbMH4ep0V3q
Hash is 111ca88e7a41017146f5c4cb8141cd20
<html>
<head>
<title>emdee five for life</title>
</head>
<body style="background-color:powderblue;">
<h1 align='center'>MD5 encrypt this string</h1><h3 align='center'>Ih4bMY9MmFbMH4ep0V3q</h3><p align='center'>FLAG_VALUE_HERE</p><center><form action="" method="post">
<input type="text" name="hash" placeholder="MD5" align='center'></input>
</br>
<input type="submit" value="Submit"></input>
</form></center>
</body>
</html>
```
